<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OrbitXE TV</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface2: #1e1e1e;
      --accent: #00ff88;
      --text: #ffffff;
      --text2: #888888;
      --focus-ring: 4px solid var(--accent);
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
      font-size: 24px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 30px 60px;
      background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, transparent 100%);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
    }

    .logo {
      font-size: 42px;
      font-weight: 700;
      letter-spacing: 2px;
    }

    .logo span { color: var(--accent); }

    .header-right {
      display: flex;
      align-items: center;
      gap: 40px;
    }

    .clock {
      font-size: 36px;
      font-weight: 300;
    }

    .room-code {
      background: var(--surface2);
      padding: 12px 24px;
      border-radius: 12px;
      font-size: 24px;
      font-family: monospace;
    }

    /* Main content */
    .main {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 120px 60px 60px;
    }

    .section-title {
      font-size: 28px;
      color: var(--text2);
      margin-bottom: 30px;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    /* App Grid */
    .app-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 30px;
      max-width: 1600px;
    }

    .app-card {
      background: var(--surface);
      border-radius: 20px;
      aspect-ratio: 16/9;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 4px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .app-card:hover,
    .app-card.focused {
      transform: scale(1.08);
      border-color: var(--accent);
      box-shadow: 0 0 40px rgba(0, 255, 136, 0.3);
      z-index: 10;
    }

    .app-card.focused::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(0,255,136,0.1) 0%, transparent 50%);
    }

    .app-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      border-radius: 16px;
      object-fit: contain;
    }

    .app-icon-placeholder {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      border-radius: 16px;
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
    }

    .app-name {
      font-size: 22px;
      font-weight: 500;
    }

    /* QR Section */
    .qr-section {
      position: fixed;
      bottom: 40px;
      right: 60px;
      display: flex;
      align-items: center;
      gap: 30px;
      background: var(--surface);
      padding: 24px 36px;
      border-radius: 20px;
    }

    .qr-text {
      text-align: right;
    }

    .qr-title {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .qr-subtitle {
      font-size: 18px;
      color: var(--text2);
    }

    .qr-url {
      font-size: 14px;
      color: var(--accent);
      font-family: monospace;
      margin-top: 8px;
      max-width: 200px;
      word-break: break-all;
    }

    .qr-code {
      width: 120px;
      height: 120px;
      background: white;
      border-radius: 12px;
      padding: 8px;
    }

    .qr-code img {
      width: 100%;
      height: 100%;
    }

    /* Network toggle */
    .network-toggle {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .network-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      background: var(--surface2);
      border: 1px solid #333;
      color: var(--text2);
      transition: all 0.2s;
    }

    .network-btn.active {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .network-btn:hover:not(.active) {
      border-color: var(--accent);
    }

    .local-ip {
      font-size: 14px;
      color: var(--text2);
      margin-top: 8px;
      font-family: monospace;
    }

    .ip-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 8px;
    }

    .ip-btn {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      cursor: pointer;
      background: var(--surface2);
      border: 1px solid #333;
      color: var(--text2);
      font-family: monospace;
    }

    .ip-btn.active {
      background: rgba(0, 255, 136, 0.2);
      border-color: var(--accent);
      color: var(--accent);
    }

    /* Status */
    .status-bar {
      position: fixed;
      bottom: 40px;
      left: 60px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .status-dot {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s infinite;
    }

    .status-dot.disconnected {
      background: #ff4444;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .status-text {
      font-size: 20px;
      color: var(--text2);
    }

    /* Fullscreen app view */
    .app-fullscreen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 1000;
      display: none;
    }

    .app-fullscreen.active {
      display: block;
    }

    .app-fullscreen iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .back-hint {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(0,0,0,0.8);
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 18px;
      z-index: 1001;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .app-fullscreen.active .back-hint {
      opacity: 1;
      animation: fadeOut 3s forwards 2s;
    }

    @keyframes fadeOut {
      to { opacity: 0; }
    }

    /* Search overlay */
    .search-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .search-overlay.active {
      display: flex;
    }

    .search-box {
      background: var(--surface);
      padding: 30px 60px;
      border-radius: 20px;
      min-width: 600px;
      text-align: center;
    }

    .search-query {
      font-size: 48px;
      color: var(--accent);
      margin-bottom: 20px;
      min-height: 60px;
    }

    .search-hint {
      font-size: 24px;
      color: var(--text2);
    }

    /* Listening indicator */
    .listening {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .listening-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      animation: listening 0.8s infinite alternate;
    }

    .listening-dot:nth-child(2) { animation-delay: 0.2s; }
    .listening-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes listening {
      from { transform: scaleY(1); }
      to { transform: scaleY(2); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">Orbit<span>XE</span> TV</div>
    <div class="header-right">
      <div class="clock" id="clock">--:--</div>
      <div class="room-code" id="roomCode">------</div>
    </div>
  </header>

  <main class="main">
    <h2 class="section-title">Apps</h2>
    <div class="app-grid" id="appGrid"></div>
  </main>

  <div class="qr-section">
    <div class="qr-text">
      <div class="qr-title">Scan to Connect Remote</div>
      <div class="qr-subtitle" id="connectionMode">Local Network</div>
      <div class="qr-url" id="remoteUrl">Loading...</div>
      <div class="network-toggle">
        <button class="network-btn active" id="localBtn" onclick="setNetworkMode('local')">Local</button>
        <button class="network-btn" id="cloudBtn" onclick="setNetworkMode('cloud')">Cloud</button>
      </div>
      <div class="ip-selector" id="ipSelector"></div>
    </div>
    <div class="qr-code">
      <img id="qrCode" src="" alt="QR Code">
    </div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="statusDot"></div>
    <div class="status-text" id="statusText">Connecting...</div>
  </div>

  <div class="app-fullscreen" id="appFullscreen">
    <div class="back-hint">Press BACK to return home</div>
    <iframe id="appFrame" src="" allow="autoplay; fullscreen; encrypted-media"></iframe>
  </div>

  <div class="search-overlay" id="searchOverlay">
    <div class="search-box">
      <div class="search-query" id="searchQuery"></div>
      <div class="search-hint">
        <div class="listening">
          <div class="listening-dot"></div>
          <div class="listening-dot"></div>
          <div class="listening-dot"></div>
          <span style="margin-left: 10px;">Listening...</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // App definitions
    const APPS = [
      { id: 'youtube', name: 'YouTube', url: 'https://www.youtube.com/tv', icon: 'YT', color: '#FF0000' },
      { id: 'netflix', name: 'Netflix', url: 'https://www.netflix.com', icon: 'N', color: '#E50914' },
      { id: 'disney', name: 'Disney+', url: 'https://www.disneyplus.com', icon: 'D+', color: '#113CCF' },
      { id: 'prime', name: 'Prime Video', url: 'https://www.primevideo.com', icon: 'P', color: '#00A8E1' },
      { id: 'hulu', name: 'Hulu', url: 'https://www.hulu.com', icon: 'h', color: '#1CE783' },
      { id: 'hbo', name: 'Max', url: 'https://play.max.com', icon: 'M', color: '#B397FF' },
      { id: 'peacock', name: 'Peacock', url: 'https://www.peacocktv.com', icon: 'P', color: '#000000' },
      { id: 'spotify', name: 'Spotify', url: 'https://open.spotify.com', icon: 'S', color: '#1DB954' },
      { id: 'twitch', name: 'Twitch', url: 'https://www.twitch.tv', icon: 'T', color: '#9146FF' },
      { id: 'browser', name: 'Browser', url: null, icon: 'W', color: '#4285F4' }
    ];

    // State
    let ws = null;
    let focusedIndex = 0;
    let currentApp = null;
    const roomId = window.location.pathname.split('/').pop();
    let networkInfo = null;
    let networkMode = 'local'; // 'local' or 'cloud'
    let selectedLocalIP = 0; // Index of selected local IP

    // Initialize
    document.getElementById('roomCode').textContent = roomId;
    updateClock();
    setInterval(updateClock, 1000);
    renderApps();
    fetchNetworkInfo();
    connectWebSocket();

    // Clock
    function updateClock() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const ampm = hours >= 12 ? 'PM' : 'AM';
      const displayHours = hours % 12 || 12;
      document.getElementById('clock').textContent = `${displayHours}:${minutes} ${ampm}`;
    }

    // Render apps
    function renderApps() {
      const grid = document.getElementById('appGrid');
      grid.innerHTML = APPS.map((app, i) => `
        <div class="app-card ${i === 0 ? 'focused' : ''}" data-index="${i}" data-id="${app.id}" onclick="launchApp('${app.id}')">
          <div class="app-icon-placeholder" style="background: ${app.color}20; color: ${app.color}">${app.icon}</div>
          <div class="app-name">${app.name}</div>
        </div>
      `).join('');
    }

    // Focus management
    function updateFocus(newIndex) {
      const cards = document.querySelectorAll('.app-card');
      if (newIndex < 0 || newIndex >= cards.length) return;

      cards[focusedIndex].classList.remove('focused');
      focusedIndex = newIndex;
      cards[focusedIndex].classList.add('focused');
      cards[focusedIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // D-pad navigation
    function handleDpad(direction) {
      const cols = 5;
      const total = APPS.length;

      switch (direction) {
        case 'up':
          if (focusedIndex >= cols) updateFocus(focusedIndex - cols);
          break;
        case 'down':
          if (focusedIndex + cols < total) updateFocus(focusedIndex + cols);
          break;
        case 'left':
          if (focusedIndex % cols !== 0) updateFocus(focusedIndex - 1);
          break;
        case 'right':
          if ((focusedIndex + 1) % cols !== 0 && focusedIndex + 1 < total) updateFocus(focusedIndex + 1);
          break;
        case 'enter':
          const app = APPS[focusedIndex];
          launchApp(app.id);
          break;
        case 'back':
          closeApp();
          break;
      }
    }

    // Launch app
    function launchApp(appId) {
      const app = APPS.find(a => a.id === appId);
      if (!app) return;

      if (app.id === 'browser') {
        // Open URL input modal
        showSearch('Type URL or search...');
        return;
      }

      currentApp = app;

      // Open in new window/tab (most streaming services block iframes)
      window.open(app.url, '_blank');

      // Notify phone remote
      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'tvState', currentApp: app.id, view: 'app' }));
      }
    }

    // Close app
    function closeApp() {
      const fullscreen = document.getElementById('appFullscreen');
      fullscreen.classList.remove('active');
      document.getElementById('appFrame').src = '';
      currentApp = null;

      if (ws && ws.readyState === 1) {
        ws.send(JSON.stringify({ type: 'tvState', currentApp: null, view: 'home' }));
      }
    }

    // Search/Voice
    function showSearch(placeholder) {
      document.getElementById('searchQuery').textContent = placeholder || '';
      document.getElementById('searchOverlay').classList.add('active');
    }

    function hideSearch() {
      document.getElementById('searchOverlay').classList.remove('active');
    }

    function handleVoiceSearch(query) {
      document.getElementById('searchQuery').textContent = query;

      // After final result, search on YouTube
      setTimeout(() => {
        hideSearch();
        window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(query)}`, '_blank');
      }, 1000);
    }

    // Network info
    async function fetchNetworkInfo() {
      try {
        const res = await fetch('/api/network');
        networkInfo = await res.json();
        console.log('Network info:', networkInfo);

        // Render IP selector if multiple IPs
        renderIPSelector();

        // Default to local if available, otherwise cloud
        if (networkInfo.localUrl) {
          setNetworkMode('local');
        } else if (networkInfo.cloudUrl) {
          setNetworkMode('cloud');
        } else {
          // Fallback to current origin
          generateQR(window.location.origin);
        }
      } catch (e) {
        console.error('Failed to fetch network info:', e);
        generateQR(window.location.origin);
      }
    }

    // Render IP selector buttons
    function renderIPSelector() {
      const selector = document.getElementById('ipSelector');
      if (!networkInfo?.localUrls || networkInfo.localUrls.length <= 1) {
        selector.innerHTML = '';
        return;
      }

      selector.innerHTML = networkInfo.localUrls.map((ip, i) => `
        <button class="ip-btn ${i === selectedLocalIP ? 'active' : ''}"
                onclick="selectLocalIP(${i})"
                title="${ip.name}">
          ${ip.name}: ${ip.url.replace('http://', '').replace(':3000', '')}
        </button>
      `).join('');
    }

    // Select a specific local IP
    function selectLocalIP(index) {
      selectedLocalIP = index;
      renderIPSelector();
      if (networkMode === 'local') {
        setNetworkMode('local');
      }
    }

    // Set network mode
    function setNetworkMode(mode) {
      networkMode = mode;

      // Update buttons
      document.getElementById('localBtn').classList.toggle('active', mode === 'local');
      document.getElementById('cloudBtn').classList.toggle('active', mode === 'cloud');

      // Show/hide IP selector
      document.getElementById('ipSelector').style.display = mode === 'local' ? 'flex' : 'none';

      // Get the appropriate URL
      let baseUrl;
      if (mode === 'local' && networkInfo?.localUrls?.length > 0) {
        baseUrl = networkInfo.localUrls[selectedLocalIP]?.url || networkInfo.localUrl;
        const ipName = networkInfo.localUrls[selectedLocalIP]?.name || 'WiFi';
        document.getElementById('connectionMode').textContent = `Local Network (${ipName})`;
      } else if (mode === 'cloud' && networkInfo?.cloudUrl) {
        baseUrl = networkInfo.cloudUrl;
        document.getElementById('connectionMode').textContent = 'Cloud (Anywhere)';
      } else {
        baseUrl = window.location.origin;
        document.getElementById('connectionMode').textContent = mode === 'local' ? 'Local Network' : 'Cloud';
      }

      generateQR(baseUrl);
    }

    // QR Code
    function generateQR(baseUrl) {
      baseUrl = baseUrl || window.location.origin;
      const remoteUrl = `${baseUrl}/remote/${roomId}`;
      document.getElementById('remoteUrl').textContent = remoteUrl;
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(remoteUrl)}&bgcolor=ffffff&color=000000`;
      document.getElementById('qrCode').src = qrUrl;
    }

    // WebSocket
    function connectWebSocket() {
      const wsUrl = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/${roomId}`;
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        console.log('Connected to server');
        ws.send(JSON.stringify({ type: 'join', roomId, role: 'display', subtype: 'tv' }));
        updateStatus(true);
      };

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        console.log('Received:', msg);

        switch (msg.type) {
          case 'dpad':
            handleDpad(msg.direction);
            break;
          case 'launchApp':
            launchApp(msg.appId);
            break;
          case 'home':
            closeApp();
            hideSearch();
            break;
          case 'voice':
            showSearch('');
            handleVoiceSearch(msg.query);
            break;
          case 'volume':
            handleVolume(msg.action);
            break;
          case 'status':
            document.getElementById('statusText').textContent =
              msg.controllers > 0 ? `${msg.controllers} remote(s) connected` : 'Waiting for remote...';
            break;
        }
      };

      ws.onclose = () => {
        console.log('Disconnected');
        updateStatus(false);
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = (e) => {
        console.error('WebSocket error:', e);
      };
    }

    function updateStatus(connected) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');

      if (connected) {
        dot.classList.remove('disconnected');
        text.textContent = 'Waiting for remote...';
      } else {
        dot.classList.add('disconnected');
        text.textContent = 'Disconnected';
      }
    }

    // Volume (for HTML5 video elements)
    function handleVolume(action) {
      const video = document.querySelector('video');
      if (!video) return;

      switch (action) {
        case 'up':
          video.volume = Math.min(1, video.volume + 0.1);
          break;
        case 'down':
          video.volume = Math.max(0, video.volume - 0.1);
          break;
        case 'mute':
          video.muted = !video.muted;
          break;
      }
    }

    // Keyboard controls (for testing)
    document.addEventListener('keydown', (e) => {
      switch (e.key) {
        case 'ArrowUp': handleDpad('up'); break;
        case 'ArrowDown': handleDpad('down'); break;
        case 'ArrowLeft': handleDpad('left'); break;
        case 'ArrowRight': handleDpad('right'); break;
        case 'Enter': handleDpad('enter'); break;
        case 'Escape':
        case 'Backspace': handleDpad('back'); break;
      }
    });
  </script>
</body>
</html>
