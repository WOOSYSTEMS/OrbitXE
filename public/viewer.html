<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0a0a0a">
  <title>OrbitXE Remote</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --accent: #00ff88;
      --bg: #0a0a0a;
      --surface: #141414;
      --surface2: #1e1e1e;
      --text: #fff;
      --text2: #666;
    }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      overflow: hidden;
      touch-action: none;
      user-select: none;
    }
    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid #222;
    }
    .logo { font-size: 16px; font-weight: 700; }
    .logo span { color: var(--accent); }
    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text2);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
    }
    .status-dot.connected { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

    /* Trackpad */
    .trackpad-container { flex: 1; padding: 12px; display: flex; flex-direction: column; }
    .trackpad {
      flex: 1;
      background: linear-gradient(145deg, var(--surface), var(--surface2));
      border-radius: 16px;
      position: relative;
      border: 1px solid #222;
      min-height: 200px;
    }
    .trackpad-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #333;
      pointer-events: none;
    }
    .trackpad-hint .title { font-size: 14px; font-weight: 500; }
    .trackpad-hint .sub { font-size: 11px; margin-top: 6px; }
    .trackpad.active .trackpad-hint { opacity: 0.3; }
    .touch-ripple {
      position: absolute;
      width: 60px;
      height: 60px;
      background: rgba(0, 255, 136, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      pointer-events: none;
      animation: ripple 0.4s ease-out forwards;
    }
    @keyframes ripple { to { transform: translate(-50%, -50%) scale(1); opacity: 0; } }

    /* Scroll buttons */
    .scroll-btns {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 8px 12px;
    }
    .scroll-btn {
      width: 60px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 10px;
      color: #888;
      cursor: pointer;
    }
    .scroll-btn:active { background: var(--accent); color: #000; }

    /* Context controls */
    .context-controls {
      display: flex;
      gap: 6px;
      padding: 8px 12px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .context-controls::-webkit-scrollbar { display: none; }
    .ctx-btn {
      flex-shrink: 0;
      padding: 10px 14px;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 10px;
      color: var(--text);
      font-size: 12px;
      cursor: pointer;
    }
    .ctx-btn:active { background: var(--accent); color: #000; }

    /* Bottom bar */
    .bottom-bar {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 10px 12px;
      background: var(--surface);
      border-top: 1px solid #222;
    }
    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 12px;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
    }
    .action-btn:active { background: var(--accent); color: #000; }
    .action-btn svg { width: 22px; height: 22px; }
    .action-btn span { font-size: 10px; color: var(--text2); }
    .action-btn:active span { color: #000; }
    .action-btn.primary { background: var(--accent); color: #000; }
    .action-btn.primary span { color: #000; }

    /* Keyboard overlay */
    .keyboard-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid #333;
      transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .keyboard-overlay.active { transform: translateY(0); }
    .keyboard-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      gap: 10px;
    }
    .keyboard-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 16px;
    }
    .keyboard-input:focus { outline: none; border-color: var(--accent); }
    .keyboard-done {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      color: #000;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Connection overlay */
    .connecting {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      z-index: 200;
    }
    .connecting.hidden { display: none; }
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #222;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .connecting .logo { font-size: 28px; margin-bottom: 24px; }
    .connecting p { margin-top: 16px; color: var(--text2); font-size: 13px; }
  </style>
</head>
<body>
  <div class="connecting" id="connecting">
    <div class="logo">ORBIT<span>XE</span></div>
    <div class="spinner"></div>
    <p id="statusMsg">Connecting to desktop...</p>
  </div>

  <div class="app">
    <header class="header">
      <div class="logo">ORBIT<span>XE</span></div>
      <div class="status">
        <span id="statusText">Connecting</span>
        <div class="status-dot" id="statusDot"></div>
      </div>
    </header>

    <div class="trackpad-container">
      <div class="trackpad" id="trackpad">
        <div class="trackpad-hint">
          <div class="title">Swipe to move cursor</div>
          <div class="sub">Tap = Click · Hold = Right-click · 2 fingers = Scroll</div>
        </div>
      </div>
    </div>

    <div class="scroll-btns">
      <button class="scroll-btn" id="scrollUp">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
      </button>
      <button class="scroll-btn" id="scrollDown">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
      </button>
    </div>

    <div class="context-controls">
      <button class="ctx-btn" data-action="escape">Esc</button>
      <button class="ctx-btn" data-action="enter">Enter</button>
      <button class="ctx-btn" data-action="space">Space</button>
      <button class="ctx-btn" data-action="tab">Tab</button>
      <button class="ctx-btn" data-action="undo">Undo</button>
      <button class="ctx-btn" data-action="copy">Copy</button>
      <button class="ctx-btn" data-action="paste">Paste</button>
      <button class="ctx-btn" data-action="select-all">Select All</button>
    </div>

    <div class="bottom-bar">
      <button class="action-btn" id="btnClick">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/></svg>
        <span>Click</span>
      </button>
      <button class="action-btn primary" id="btnKeyboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 16h8"/></svg>
        <span>Type</span>
      </button>
      <button class="action-btn" id="btnClipboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1"/></svg>
        <span>Clipboard</span>
      </button>
      <button class="action-btn" id="btnWake">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2"/></svg>
        <span>Wake</span>
      </button>
    </div>
  </div>

  <div class="keyboard-overlay" id="keyboardOverlay">
    <div class="keyboard-header">
      <input type="text" class="keyboard-input" id="keyboardInput" placeholder="Type here..." autocomplete="off" autocapitalize="off">
      <button class="keyboard-done" id="keyboardDone">Done</button>
    </div>
  </div>

  <script>
    const pathParts = window.location.pathname.split('/');
    const code = pathParts[pathParts.length - 1];

    if (!code || code.length < 4) {
      document.getElementById('statusMsg').textContent = 'Invalid code';
      throw new Error('Invalid code');
    }

    const connecting = document.getElementById('connecting');
    const statusMsg = document.getElementById('statusMsg');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const trackpad = document.getElementById('trackpad');

    let ws = null;
    let connected = false;

    // Trackpad state
    let lastTouchX = 0, lastTouchY = 0;
    let touchStartTime = 0;
    let isTouching = false;
    let moved = false;
    let lastTwoFinger = null;
    const SENSITIVITY = 1.8;

    function connect() {
      statusMsg.textContent = 'Connecting...';
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${proto}//${location.host}/?code=${code}&role=phone`);

      ws.onopen = () => {
        statusMsg.textContent = 'Waiting for desktop...';
      };

      ws.onmessage = (e) => {
        try {
          const msg = JSON.parse(e.data);
          if (msg.type === 'desktop-connected') {
            connected = true;
            connecting.classList.add('hidden');
            statusDot.classList.add('connected');
            statusText.textContent = 'Connected';
          } else if (msg.type === 'desktop-disconnected') {
            connected = false;
            connecting.classList.remove('hidden');
            statusMsg.textContent = 'Desktop disconnected';
            statusDot.classList.remove('connected');
            statusText.textContent = 'Disconnected';
          } else if (msg.type === 'clipboard-content' && msg.text) {
            navigator.clipboard.writeText(msg.text).then(() => {
              alert('Clipboard synced!');
            }).catch(() => {
              alert('Clipboard: ' + msg.text.slice(0, 100));
            });
          }
        } catch (err) {}
      };

      ws.onclose = () => {
        connected = false;
        connecting.classList.remove('hidden');
        statusMsg.textContent = 'Disconnected - reconnecting...';
        statusDot.classList.remove('connected');
        setTimeout(connect, 2000);
      };

      ws.onerror = () => {
        statusMsg.textContent = 'Connection error';
      };
    }

    function send(msg) {
      if (ws?.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(msg));
        if (navigator.vibrate) navigator.vibrate(10);
      }
    }

    // Trackpad
    trackpad.addEventListener('touchstart', (e) => {
      e.preventDefault();
      trackpad.classList.add('active');
      const touch = e.touches[0];
      lastTouchX = touch.clientX;
      lastTouchY = touch.clientY;
      touchStartTime = Date.now();
      isTouching = true;
      moved = false;
    }, { passive: false });

    trackpad.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!isTouching) return;

      // Two-finger scroll
      if (e.touches.length === 2) {
        const avgY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        if (lastTwoFinger !== null) {
          const dy = lastTwoFinger - avgY;
          send({ type: 'mouse-scroll', deltaY: dy * 3 });
        }
        lastTwoFinger = avgY;
        return;
      }
      lastTwoFinger = null;

      const touch = e.touches[0];
      const deltaX = (touch.clientX - lastTouchX) * SENSITIVITY;
      const deltaY = (touch.clientY - lastTouchY) * SENSITIVITY;

      if (Math.abs(deltaX) > 1 || Math.abs(deltaY) > 1) {
        moved = true;
        send({ type: 'mouse-move-delta', deltaX, deltaY });
      }

      lastTouchX = touch.clientX;
      lastTouchY = touch.clientY;
    }, { passive: false });

    trackpad.addEventListener('touchend', (e) => {
      e.preventDefault();
      trackpad.classList.remove('active');
      isTouching = false;
      lastTwoFinger = null;

      const duration = Date.now() - touchStartTime;

      if (!moved) {
        const rect = trackpad.getBoundingClientRect();
        const x = e.changedTouches[0].clientX - rect.left;
        const y = e.changedTouches[0].clientY - rect.top;
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        trackpad.appendChild(ripple);
        setTimeout(() => ripple.remove(), 400);

        if (duration < 200) {
          send({ type: 'mouse-click-current', button: 'left' });
        } else if (duration >= 400) {
          send({ type: 'mouse-click-current', button: 'right' });
        }
      }
    }, { passive: false });

    // Scroll buttons
    document.getElementById('scrollUp').onclick = () => send({ type: 'mouse-scroll', deltaY: -300 });
    document.getElementById('scrollDown').onclick = () => send({ type: 'mouse-scroll', deltaY: 300 });

    // Context buttons
    document.querySelectorAll('[data-action]').forEach(btn => {
      btn.onclick = () => {
        const action = btn.dataset.action;
        switch (action) {
          case 'escape': send({ type: 'key-down', key: 'escape' }); break;
          case 'enter': send({ type: 'key-down', key: 'return' }); break;
          case 'space': send({ type: 'key-down', key: 'space' }); break;
          case 'tab': send({ type: 'key-down', key: 'tab' }); break;
          case 'undo': send({ type: 'shortcut', key: 'z' }); break;
          case 'copy': send({ type: 'shortcut', key: 'c' }); break;
          case 'paste': send({ type: 'shortcut', key: 'v' }); break;
          case 'select-all': send({ type: 'shortcut', key: 'a' }); break;
        }
      };
    });

    // Bottom bar
    document.getElementById('btnClick').onclick = () => send({ type: 'mouse-click-current', button: 'left' });
    document.getElementById('btnWake').onclick = () => send({ type: 'wake' });
    document.getElementById('btnClipboard').onclick = () => send({ type: 'clipboard-get' });

    // Keyboard
    const keyboardOverlay = document.getElementById('keyboardOverlay');
    const keyboardInput = document.getElementById('keyboardInput');
    let lastInputValue = '';

    document.getElementById('btnKeyboard').onclick = () => {
      keyboardOverlay.classList.add('active');
      keyboardInput.value = '';
      lastInputValue = '';
      setTimeout(() => keyboardInput.focus(), 100);
    };

    document.getElementById('keyboardDone').onclick = () => {
      keyboardOverlay.classList.remove('active');
      keyboardInput.blur();
    };

    keyboardInput.addEventListener('input', () => {
      const val = keyboardInput.value;
      if (val.length > lastInputValue.length) {
        const newChar = val.slice(lastInputValue.length);
        for (const char of newChar) {
          send({ type: 'key-press', key: char });
        }
      } else if (val.length < lastInputValue.length) {
        for (let i = 0; i < lastInputValue.length - val.length; i++) {
          send({ type: 'key-down', key: 'backspace' });
        }
      }
      lastInputValue = val;
    });

    keyboardInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') send({ type: 'key-down', key: 'return' });
    });

    connect();
  </script>
</body>
</html>
