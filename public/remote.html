<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>OrbitXE Remote</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --accent: #00ff88;
      --bg: #0a0a0a;
      --surface: #141414;
      --surface2: #1e1e1e;
      --text: #ffffff;
      --text2: #666666;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
      overflow: hidden;
      touch-action: none;
      user-select: none;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--surface);
    }

    .logo {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .logo span { color: var(--accent); }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text2);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
      transition: all 0.3s;
    }
    .status-dot.connected { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

    /* Tab bar */
    .tab-bar {
      display: flex;
      gap: 6px;
      padding: 8px 12px;
      overflow-x: auto;
      background: var(--surface);
      border-bottom: 1px solid #222;
      scrollbar-width: none;
    }
    .tab-bar::-webkit-scrollbar { display: none; }

    .tab-item {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--surface2);
      border-radius: 6px;
      font-size: 11px;
      max-width: 120px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .tab-item.active {
      border-color: var(--accent);
      background: rgba(0, 255, 136, 0.1);
    }
    .tab-item img {
      width: 14px;
      height: 14px;
      border-radius: 2px;
    }
    .tab-item span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Active tab display */
    .active-tab {
      padding: 8px 16px;
      font-size: 12px;
      color: var(--text2);
      background: var(--surface);
      border-bottom: 1px solid #222;
    }
    .active-tab strong { color: var(--accent); font-weight: 500; }

    /* Main area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Trackpad */
    .trackpad {
      flex: 1;
      margin: 12px;
      background: linear-gradient(145deg, var(--surface), var(--surface2));
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      border: 1px solid #222;
    }

    .trackpad-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #333;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .trackpad-hint svg { margin-bottom: 8px; }
    .trackpad-hint .title { font-size: 13px; font-weight: 500; }
    .trackpad-hint .sub { font-size: 11px; margin-top: 4px; }

    .trackpad.active .trackpad-hint { opacity: 0.3; }

    /* Context controls */
    .context-controls {
      display: flex;
      gap: 6px;
      padding: 6px 12px;
      overflow-x: auto;
      scrollbar-width: none;
      background: var(--surface);
    }
    .context-controls::-webkit-scrollbar { display: none; }

    .ctx-btn {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 10px 14px;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 10px;
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .ctx-btn:active {
      transform: scale(0.95);
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    /* Bottom bar */
    .bottom-bar {
      display: grid;
      grid-template-columns: 1fr 1.5fr 1fr 1fr;
      gap: 8px;
      padding: 10px 12px;
      background: var(--surface);
      border-top: 1px solid #222;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
    }
    .action-btn:active { transform: scale(0.95); }
    .action-btn.primary {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    .action-btn svg { width: 22px; height: 22px; }

    /* Keyboard overlay */
    .keyboard-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid #333;
      transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: 100;
      padding-bottom: var(--safe-bottom);
    }
    .keyboard-overlay.active { transform: translateY(0); }

    .keyboard-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      gap: 10px;
      border-bottom: 1px solid #222;
    }
    .keyboard-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 16px;
    }
    .keyboard-input:focus { outline: none; border-color: var(--accent); }

    .keyboard-done {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      color: #000;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }


    /* Scroll buttons */
    .scroll-btns {
      display: flex;
      justify-content: center;
      gap: 12px;
      padding: 8px 12px;
    }
    .scroll-btn {
      width: 60px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 10px;
      color: #888;
      cursor: pointer;
      font-size: 14px;
    }
    .scroll-btn:active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* URL overlay */
    .url-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      padding: 12px;
      padding-top: calc(12px + var(--safe-top));
      transform: translateY(-100%);
      transition: transform 0.25s ease;
      z-index: 100;
    }
    .url-overlay.active { transform: translateY(0); }
    .url-header {
      display: flex;
      gap: 8px;
    }
    .url-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px;
      color: var(--text);
      font-size: 16px;
    }
    .url-input:focus { outline: none; border-color: var(--accent); }
    .url-go {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      color: #000;
      font-weight: 600;
      cursor: pointer;
    }
    .url-cancel {
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 12px 16px;
      color: var(--text);
      cursor: pointer;
    }

    /* Connection overlay */
    .connecting {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      z-index: 200;
      transition: opacity 0.3s;
    }
    .connecting.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #222;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .connecting p { margin-top: 16px; color: var(--text2); font-size: 13px; }

    /* Touch feedback */
    .touch-ripple {
      position: absolute;
      width: 60px;
      height: 60px;
      background: rgba(0, 255, 136, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      pointer-events: none;
      animation: ripple 0.4s ease-out forwards;
    }
    @keyframes ripple {
      to { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }

    /* License banner */
    .license-banner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 152, 0, 0.15));
      border-bottom: 1px solid rgba(255, 193, 7, 0.3);
      font-size: 11px;
    }
    .license-banner.free {
      background: linear-gradient(135deg, rgba(108, 117, 125, 0.15), rgba(100, 100, 100, 0.15));
      border-color: rgba(108, 117, 125, 0.3);
    }
    .license-banner.pro, .license-banner.lifetime {
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(0, 200, 100, 0.1));
      border-color: rgba(0, 255, 136, 0.3);
    }
    .license-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .tier-badge {
      font-size: 9px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .tier-badge.trial { background: rgba(255, 193, 7, 0.3); color: #ffc107; }
    .tier-badge.free { background: rgba(108, 117, 125, 0.3); color: #888; }
    .tier-badge.pro { background: rgba(0, 255, 136, 0.3); color: #00ff88; }
    .tier-badge.lifetime { background: linear-gradient(135deg, rgba(147, 51, 234, 0.4), rgba(236, 72, 153, 0.4)); color: #d946ef; }
    .license-text { color: var(--text2); }
    .license-text strong { color: var(--text); }
    .upgrade-link {
      color: var(--accent);
      font-weight: 500;
      text-decoration: none;
      padding: 4px 10px;
      background: rgba(0, 255, 136, 0.15);
      border-radius: 4px;
      transition: all 0.2s;
    }
    .upgrade-link:hover { background: rgba(0, 255, 136, 0.25); }
    .hidden { display: none !important; }

    /* Pro badge on features */
    .pro-badge {
      font-size: 8px;
      font-weight: 700;
      padding: 2px 4px;
      background: rgba(0, 255, 136, 0.3);
      color: var(--accent);
      border-radius: 3px;
      margin-left: 4px;
      text-transform: uppercase;
    }

    /* Locked feature styling */
    .action-btn.locked, .ctx-btn.locked, .tab-item.locked {
      opacity: 0.4;
      position: relative;
    }
    .action-btn.locked::after, .ctx-btn.locked::after {
      content: 'PRO';
      position: absolute;
      top: -4px;
      right: -4px;
      font-size: 7px;
      font-weight: 700;
      padding: 1px 3px;
      background: var(--accent);
      color: #000;
      border-radius: 2px;
    }

    /* Upgrade modal */
    .upgrade-modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
    }
    .upgrade-modal.active {
      opacity: 1;
      pointer-events: auto;
    }
    .upgrade-content {
      background: var(--surface);
      border-radius: 16px;
      padding: 24px;
      max-width: 300px;
      text-align: center;
      border: 1px solid #333;
    }
    .upgrade-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      background: rgba(0, 255, 136, 0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .upgrade-icon svg {
      width: 24px;
      height: 24px;
      color: var(--accent);
    }
    .upgrade-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .upgrade-desc {
      font-size: 13px;
      color: var(--text2);
      margin-bottom: 20px;
      line-height: 1.5;
    }
    .upgrade-feature {
      color: var(--accent);
      font-weight: 500;
    }
    .upgrade-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #000;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .upgrade-btn:active { transform: scale(0.98); }
    .upgrade-close {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid #333;
      border-radius: 10px;
      color: var(--text2);
      font-size: 13px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="connecting" id="connecting">
    <div class="spinner"></div>
    <p>Connecting to browser...</p>
  </div>

  <!-- Upgrade modal -->
  <div class="upgrade-modal" id="upgradeModal">
    <div class="upgrade-content">
      <div class="upgrade-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
        </svg>
      </div>
      <div class="upgrade-title">Pro Feature</div>
      <div class="upgrade-desc">
        <span class="upgrade-feature" id="blockedFeature">This feature</span> requires OrbitXE Pro.<br>
        Unlock all features for just $3.99/mo or $19.99 lifetime.
      </div>
      <button class="upgrade-btn" id="upgradeBtn">Upgrade to Pro</button>
      <button class="upgrade-close" id="upgradeClose">Maybe Later</button>
    </div>
  </div>

  <div class="app">
    <!-- License banner -->
    <div class="license-banner hidden" id="licenseBanner">
      <div class="license-info">
        <span class="tier-badge" id="tierBadge">TRIAL</span>
        <span class="license-text" id="licenseText"><strong>7 days</strong> left in trial</span>
      </div>
      <a href="#" class="upgrade-link" id="upgradeLink">Upgrade</a>
    </div>

    <header class="header">
      <div class="logo">ORBIT<span>XE</span></div>
      <div class="status">
        <span id="statusText">Waiting</span>
        <div class="status-dot" id="statusDot"></div>
      </div>
    </header>

    <div class="tab-bar" id="tabBar"></div>

    <div class="active-tab" id="activeTab">
      <strong>Waiting for browser...</strong>
    </div>

    <div class="main">
      <div class="trackpad" id="trackpad">
        <div class="trackpad-hint">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l3 3 3-3M19 9l3 3-3 3"/>
            <circle cx="12" cy="12" r="2"/>
          </svg>
          <div class="title">Swipe to move cursor</div>
          <div class="sub">Tap to click · Hold for right-click</div>
        </div>

      </div>

      <div class="scroll-btns">
        <button class="scroll-btn" data-scroll="up">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
        </button>
        <button class="scroll-btn" data-scroll="down">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </button>
      </div>

      <div class="context-controls" id="contextControls"></div>
    </div>

    <div class="bottom-bar">
      <button class="action-btn" id="btnBack">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      </button>
      <button class="action-btn primary" id="btnKeyboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"/></svg>
      </button>
      <button class="action-btn" id="btnNewTab">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
      </button>
      <button class="action-btn" id="btnRefresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
      </button>
    </div>

    <!-- URL input overlay -->
    <div class="url-overlay" id="urlOverlay">
      <div class="url-header">
        <input type="url" class="url-input" id="urlInput" placeholder="Enter URL or search..." autocomplete="off" autocapitalize="off">
        <button class="url-go" id="urlGo">Go</button>
        <button class="url-cancel" id="urlCancel">X</button>
      </div>
    </div>
  </div>

  <div class="keyboard-overlay" id="keyboardOverlay">
    <div class="keyboard-header">
      <input type="text" class="keyboard-input" id="keyboardInput" placeholder="Type here..." autocomplete="off">
      <button class="keyboard-done" id="keyboardDone">Done</button>
    </div>
  </div>

  <script>
    let ws = null;
    let connected = false;
    let activeTab = null;
    let siteType = 'universal';
    let tabs = [];
    let license = null;
    let upgradeUrl = `${location.origin}/upgrade`;

    // Feature definitions (must match server)
    const FREE_FEATURES = ['trackpad', 'scroll_buttons'];
    const PRO_FEATURES = ['keyboard', 'tab_switch', 'open_tab', 'youtube', 'netflix', 'slides', 'zoom', 'meet', 'two_finger_scroll'];

    const roomId = window.location.pathname.split('/').pop();
    const wsUrl = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/${roomId}`;

    // Check if user has feature
    function hasFeature(feature) {
      if (!license) return true; // Allow if no license info yet
      return license.features?.includes(feature) ?? true;
    }

    // Update license UI
    function updateLicenseUI() {
      const banner = document.getElementById('licenseBanner');
      const badge = document.getElementById('tierBadge');
      const text = document.getElementById('licenseText');
      const link = document.getElementById('upgradeLink');

      if (!license) {
        banner.classList.add('hidden');
        return;
      }

      const tier = license.tier;
      banner.classList.remove('hidden', 'trial', 'free', 'pro', 'lifetime');
      banner.classList.add(tier);

      badge.textContent = tier.toUpperCase();
      badge.className = 'tier-badge ' + tier;

      if (tier === 'trial') {
        const days = license.daysRemaining || 7;
        text.innerHTML = `<strong>${days} day${days !== 1 ? 's' : ''}</strong> left in trial`;
        link.classList.remove('hidden');
      } else if (tier === 'free') {
        text.innerHTML = 'Limited features';
        link.classList.remove('hidden');
      } else if (tier === 'pro' || tier === 'lifetime') {
        text.innerHTML = 'All features unlocked';
        link.classList.add('hidden');
      }

      // Update locked states on buttons
      updateLockedStates();
    }

    // Update locked states on buttons
    function updateLockedStates() {
      // Keyboard button
      const kbBtn = document.getElementById('btnKeyboard');
      kbBtn.classList.toggle('locked', !hasFeature('keyboard'));

      // New tab button
      const ntBtn = document.getElementById('btnNewTab');
      ntBtn.classList.toggle('locked', !hasFeature('open_tab'));

      // Tab items
      document.querySelectorAll('.tab-item').forEach(el => {
        el.classList.toggle('locked', !hasFeature('tab_switch'));
      });
    }

    // Show upgrade modal
    function showUpgradeModal(feature) {
      const featureNames = {
        keyboard: 'Full Keyboard',
        tab_switch: 'Tab Switching',
        open_tab: 'Open New Tabs',
        youtube: 'YouTube Controls',
        netflix: 'Netflix Controls',
        slides: 'Google Slides Controls',
        zoom: 'Zoom Controls',
        meet: 'Google Meet Controls',
        two_finger_scroll: 'Two-Finger Scroll'
      };

      document.getElementById('blockedFeature').textContent = featureNames[feature] || feature;
      document.getElementById('upgradeModal').classList.add('active');
    }

    // Close upgrade modal
    function closeUpgradeModal() {
      document.getElementById('upgradeModal').classList.remove('active');
    }

    // Setup upgrade modal handlers
    document.getElementById('upgradeBtn').onclick = () => {
      window.open(upgradeUrl, '_blank');
      closeUpgradeModal();
    };
    document.getElementById('upgradeClose').onclick = closeUpgradeModal;
    document.getElementById('upgradeLink').onclick = (e) => {
      e.preventDefault();
      window.open(upgradeUrl, '_blank');
    };
    document.getElementById('upgradeModal').onclick = (e) => {
      if (e.target.id === 'upgradeModal') closeUpgradeModal();
    };

    // Connect
    function connect() {
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'join', roomId, role: 'controller' }));
        // Request tabs after a short delay to ensure browser is ready
        setTimeout(() => {
          ws.send(JSON.stringify({ type: 'getTabs' }));
        }, 500);
        // Request again after longer delay as backup
        setTimeout(() => {
          ws.send(JSON.stringify({ type: 'getTabs' }));
        }, 2000);
      };

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        console.log('OrbitXE Phone: Received:', msg.type, msg);

        if (msg.type === 'joined' || msg.type === 'status') {
          connected = msg.displays > 0;
          updateStatus();
          // Request tabs and license when status changes
          if (connected) {
            setTimeout(() => {
              ws.send(JSON.stringify({ type: 'getTabs' }));
              ws.send(JSON.stringify({ type: 'getLicense' }));
            }, 300);
          }
        }

        if (msg.type === 'activeTab') {
          activeTab = msg.tab;
          siteType = msg.siteType || 'universal';
          // Update license from activeTab message
          if (msg.license) {
            license = msg.license;
            updateLicenseUI();
          }
          updateActiveTab();
          updateContextControls();
        }

        if (msg.type === 'license') {
          license = msg.license;
          updateLicenseUI();
        }

        if (msg.type === 'featureBlocked') {
          console.log('OrbitXE Phone: Feature blocked:', msg.feature);
          if (msg.upgradeUrl) upgradeUrl = msg.upgradeUrl;
          showUpgradeModal(msg.feature);
        }

        if (msg.type === 'tabList') {
          console.log('OrbitXE Phone: Got tabList with', msg.tabs?.length, 'tabs');
          tabs = msg.tabs || [];
          renderTabs();
        }

        if (msg.type === 'showKeyboard') {
          console.log('OrbitXE Phone: Opening keyboard');
          document.getElementById('keyboardOverlay').classList.add('active');
          setTimeout(() => document.getElementById('keyboardInput').focus(), 100);
        }
      };

      ws.onclose = () => {
        connected = false;
        updateStatus();
        setTimeout(connect, 2000);
      };
    }

    function send(msg) {
      if (ws?.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(msg));
        vibrate();
      }
    }

    function vibrate() {
      if (navigator.vibrate) navigator.vibrate(15);
    }

    // Status
    function updateStatus() {
      document.getElementById('connecting').classList.toggle('hidden', connected);
      document.getElementById('statusDot').classList.toggle('connected', connected);
      document.getElementById('statusText').textContent = connected ? 'Connected' : 'Waiting';
    }

    function updateActiveTab() {
      const el = document.getElementById('activeTab');
      if (activeTab) {
        try {
          const host = new URL(activeTab.url).hostname.replace('www.', '');
          el.innerHTML = `<strong>${siteType}</strong> · ${host}`;
        } catch (e) {
          el.innerHTML = `<strong>${activeTab.title?.slice(0, 30) || 'Tab'}</strong>`;
        }
      }
    }

    // Tabs
    function renderTabs() {
      const bar = document.getElementById('tabBar');
      const canSwitchTabs = hasFeature('tab_switch');
      bar.innerHTML = tabs.slice(0, 8).map(t => `
        <div class="tab-item ${t.active ? 'active' : ''} ${!canSwitchTabs && !t.active ? 'locked' : ''}" data-id="${t.id}">
          <img src="${t.favIconUrl || ''}" onerror="this.style.display='none'">
          <span>${t.title?.slice(0, 15) || 'Tab'}</span>
        </div>
      `).join('');

      bar.querySelectorAll('.tab-item').forEach(el => {
        el.onclick = () => {
          if (!hasFeature('tab_switch')) {
            showUpgradeModal('tab_switch');
            return;
          }
          send({ type: 'switchTab', tabId: parseInt(el.dataset.id) });
        };
      });
    }

    // Context controls
    const contexts = {
      youtube: [
        { action: 'play', label: 'Play/Pause' },
        { action: 'seekBack', label: '-10s' },
        { action: 'seekForward', label: '+10s' },
        { action: 'mute', label: 'Mute' },
        { action: 'fullscreen', label: 'Fullscreen' },
        { action: 'next', label: 'Next' }
      ],
      netflix: [
        { action: 'play', label: 'Play/Pause' },
        { action: 'seekBack', label: '-10s' },
        { action: 'seekForward', label: '+10s' },
        { action: 'mute', label: 'Mute' },
        { action: 'fullscreen', label: 'Fullscreen' }
      ],
      slides: [
        { action: 'prev', label: 'Prev' },
        { action: 'next', label: 'Next' },
        { action: 'play', label: 'Present' },
        { action: 'exit', label: 'Exit' }
      ],
      zoom: [
        { action: 'mute', label: 'Mute' },
        { action: 'video', label: 'Video' },
        { action: 'chat', label: 'Chat' },
        { action: 'leave', label: 'Leave' }
      ],
      meet: [
        { action: 'mute', label: 'Mute' },
        { action: 'video', label: 'Video' },
        { action: 'chat', label: 'Chat' },
        { action: 'leave', label: 'Leave' }
      ],
      universal: [
        { action: 'up', label: 'Up' },
        { action: 'down', label: 'Down' },
        { action: 'enter', label: 'Enter' },
        { action: 'escape', label: 'Esc' },
        { action: 'space', label: 'Space' },
        { action: 'tab', label: 'Tab' }
      ]
    };

    function updateContextControls() {
      const btns = contexts[siteType] || contexts.universal;
      const siteFeature = ['youtube', 'netflix', 'slides', 'zoom', 'meet'].includes(siteType) ? siteType : null;
      const canUseSiteControls = siteFeature ? hasFeature(siteFeature) : true;

      document.getElementById('contextControls').innerHTML = btns.map(b =>
        `<button class="ctx-btn ${siteFeature && !canUseSiteControls ? 'locked' : ''}" data-action="${b.action}" data-site="${siteFeature || ''}">${b.label}</button>`
      ).join('');

      document.querySelectorAll('.ctx-btn').forEach(el => {
        el.onclick = () => {
          const site = el.dataset.site;
          if (site && !hasFeature(site)) {
            showUpgradeModal(site);
            return;
          }
          send({ type: 'action', action: el.dataset.action });
        };
      });
    }

    // Trackpad
    const trackpad = document.getElementById('trackpad');
    let lastTouch = null, touchStart = 0, moved = false;

    trackpad.addEventListener('touchstart', (e) => {
      e.preventDefault();
      trackpad.classList.add('active');
      lastTouch = e.touches[0];
      touchStart = Date.now();
      moved = false;
    }, { passive: false });

    trackpad.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!lastTouch) return;
      const t = e.touches[0];
      const dx = t.clientX - lastTouch.clientX;
      const dy = t.clientY - lastTouch.clientY;
      if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
        moved = true;
        send({ type: 'mouse', x: dx, y: dy });
      }
      lastTouch = t;
    }, { passive: false });

    trackpad.addEventListener('touchend', (e) => {
      e.preventDefault();
      trackpad.classList.remove('active');
      const duration = Date.now() - touchStart;

      if (!moved) {
        // Create ripple
        const rect = trackpad.getBoundingClientRect();
        const x = e.changedTouches[0].clientX - rect.left;
        const y = e.changedTouches[0].clientY - rect.top;
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        trackpad.appendChild(ripple);
        setTimeout(() => ripple.remove(), 400);

        if (duration < 200) {
          send({ type: 'mouse', x: 0, y: 0, action: 'click' });
        } else if (duration >= 400) {
          send({ type: 'mouse', x: 0, y: 0, action: 'rightClick' });
        }
      }
      lastTouch = null;
    }, { passive: false });

    // Two-finger scroll
    let lastTwoFinger = null;
    trackpad.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const avgY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        if (lastTwoFinger !== null) {
          const dy = lastTwoFinger - avgY;
          send({ type: 'scroll', deltaY: dy * 3 });
        }
        lastTwoFinger = avgY;
      } else {
        lastTwoFinger = null;
      }
    }, { passive: false });

    trackpad.addEventListener('touchend', () => { lastTwoFinger = null; });

    // Scroll buttons
    document.querySelectorAll('[data-scroll]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const deltaY = btn.dataset.scroll === 'up' ? -300 : 300;
        console.log('Scroll button clicked:', btn.dataset.scroll, 'deltaY:', deltaY);
        send({ type: 'scroll', deltaY });
        vibrate();
      });
    });

    // Bottom buttons
    document.getElementById('btnBack').onclick = () => send({ type: 'action', action: 'back' });
    document.getElementById('btnRefresh').onclick = () => {
      // Refresh both the page and the tab list
      send({ type: 'action', action: 'refresh' });
      send({ type: 'getTabs' });
    };

    // New tab / URL input
    const urlOverlay = document.getElementById('urlOverlay');
    const urlInput = document.getElementById('urlInput');

    document.getElementById('btnNewTab').onclick = () => {
      if (!hasFeature('open_tab')) {
        showUpgradeModal('open_tab');
        return;
      }
      urlOverlay.classList.add('active');
      urlInput.value = '';
      setTimeout(() => urlInput.focus(), 100);
    };

    document.getElementById('urlCancel').onclick = () => {
      urlOverlay.classList.remove('active');
      urlInput.blur();
    };

    document.getElementById('urlGo').onclick = () => {
      let url = urlInput.value.trim();
      if (url) {
        // Add https:// if no protocol
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          // Check if it looks like a URL or a search query
          if (url.includes('.') && !url.includes(' ')) {
            url = 'https://' + url;
          } else {
            url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
          }
        }
        send({ type: 'openTab', url });
        urlOverlay.classList.remove('active');
        urlInput.blur();
      }
    };

    urlInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        document.getElementById('urlGo').click();
      }
    });

    // Keyboard - using native device keyboard
    const keyboardOverlay = document.getElementById('keyboardOverlay');
    const keyboardInput = document.getElementById('keyboardInput');
    let lastInputValue = '';

    keyboardInput.addEventListener('input', (e) => {
      const currentValue = keyboardInput.value;

      if (currentValue.length > lastInputValue.length) {
        // Character added
        const newChar = currentValue.slice(lastInputValue.length);
        send({ type: 'keyboard', text: newChar });
      } else if (currentValue.length < lastInputValue.length) {
        // Character deleted (backspace)
        const deletedCount = lastInputValue.length - currentValue.length;
        for (let i = 0; i < deletedCount; i++) {
          send({ type: 'keyboard', key: 'Backspace' });
        }
      }

      lastInputValue = currentValue;
    });

    keyboardInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        send({ type: 'keyboard', key: 'Enter' });
      }
    });

    document.getElementById('btnKeyboard').onclick = () => {
      if (!hasFeature('keyboard')) {
        showUpgradeModal('keyboard');
        return;
      }
      keyboardOverlay.classList.add('active');
      keyboardInput.value = '';
      lastInputValue = '';
      setTimeout(() => keyboardInput.focus(), 100);
    };

    document.getElementById('keyboardDone').onclick = () => {
      keyboardOverlay.classList.remove('active');
      keyboardInput.blur();
      keyboardInput.value = '';
      lastInputValue = '';
    };

    // Periodic tab refresh (backup in case push doesn't work)
    setInterval(() => {
      if (ws?.readyState === WebSocket.OPEN && connected) {
        ws.send(JSON.stringify({ type: 'getTabs' }));
      }
    }, 5000);

    // Init
    updateContextControls();
    connect();
  </script>
</body>
</html>
