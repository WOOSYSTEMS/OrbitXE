<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <title>ExodusXE Remote</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    :root {
      --accent: #00ff88;
      --bg: #0a0a0a;
      --surface: #141414;
      --surface2: #1e1e1e;
      --text: #ffffff;
      --text2: #666666;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
    }

    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif;
      overflow: hidden;
      touch-action: none;
      user-select: none;
    }

    .app {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      background: var(--surface);
    }

    .logo {
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .logo span { color: var(--accent); }

    .status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text2);
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
      transition: all 0.3s;
    }
    .status-dot.connected { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

    /* Tab bar */
    .tab-bar {
      display: flex;
      gap: 6px;
      padding: 8px 12px;
      overflow-x: auto;
      background: var(--surface);
      border-bottom: 1px solid #222;
      scrollbar-width: none;
    }
    .tab-bar::-webkit-scrollbar { display: none; }

    .tab-item {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--surface2);
      border-radius: 6px;
      font-size: 11px;
      max-width: 120px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    .tab-item.active {
      border-color: var(--accent);
      background: rgba(0, 255, 136, 0.1);
    }
    .tab-item img {
      width: 14px;
      height: 14px;
      border-radius: 2px;
    }
    .tab-item span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* Active tab display */
    .active-tab {
      padding: 8px 16px;
      font-size: 12px;
      color: var(--text2);
      background: var(--surface);
      border-bottom: 1px solid #222;
    }
    .active-tab strong { color: var(--accent); font-weight: 500; }

    /* Main area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Trackpad */
    .trackpad {
      flex: 1;
      margin: 12px;
      background: linear-gradient(145deg, var(--surface), var(--surface2));
      border-radius: 16px;
      position: relative;
      overflow: hidden;
      border: 1px solid #222;
    }

    .trackpad-hint {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: #333;
      pointer-events: none;
      transition: opacity 0.2s;
    }
    .trackpad-hint svg { margin-bottom: 8px; }
    .trackpad-hint .title { font-size: 13px; font-weight: 500; }
    .trackpad-hint .sub { font-size: 11px; margin-top: 4px; }

    .trackpad.active .trackpad-hint { opacity: 0.3; }

    /* Context controls */
    .context-controls {
      display: flex;
      gap: 6px;
      padding: 6px 12px;
      overflow-x: auto;
      scrollbar-width: none;
      background: var(--surface);
    }
    .context-controls::-webkit-scrollbar { display: none; }

    .ctx-btn {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 10px 14px;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 10px;
      color: var(--text);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }
    .ctx-btn:active {
      transform: scale(0.95);
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    /* Bottom bar */
    .bottom-bar {
      display: grid;
      grid-template-columns: 1fr 1.5fr 1fr;
      gap: 8px;
      padding: 10px 12px;
      background: var(--surface);
      border-top: 1px solid #222;
    }

    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 12px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
    }
    .action-btn:active { transform: scale(0.95); }
    .action-btn.primary {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }
    .action-btn svg { width: 22px; height: 22px; }

    /* Keyboard overlay */
    .keyboard-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid #333;
      transform: translateY(100%);
      transition: transform 0.25s ease;
      z-index: 100;
      padding-bottom: var(--safe-bottom);
    }
    .keyboard-overlay.active { transform: translateY(0); }

    .keyboard-header {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      gap: 10px;
      border-bottom: 1px solid #222;
    }
    .keyboard-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid #333;
      border-radius: 8px;
      padding: 10px 12px;
      color: var(--text);
      font-size: 16px;
    }
    .keyboard-input:focus { outline: none; border-color: var(--accent); }

    .keyboard-done {
      background: var(--accent);
      border: none;
      border-radius: 8px;
      padding: 10px 16px;
      color: #000;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .keyboard-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 8px;
      justify-content: center;
    }

    .keyboard-row {
      display: flex;
      gap: 4px;
      width: 100%;
      justify-content: center;
    }

    .key {
      min-width: 28px;
      height: 42px;
      padding: 0 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--surface2);
      border: none;
      border-radius: 6px;
      color: var(--text);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.1s;
      flex: 1;
      max-width: 36px;
    }
    .key:active { background: var(--accent); color: #000; }
    .key.wide { flex: 1.5; max-width: 50px; font-size: 14px; }
    .key.space { flex: 4; max-width: 200px; font-size: 12px; }

    /* Scroll buttons in trackpad */
    .scroll-btns {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .scroll-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255,255,255,0.05);
      border: 1px solid #333;
      border-radius: 10px;
      color: #666;
      cursor: pointer;
    }
    .scroll-btn:active { background: var(--accent); color: #000; border-color: var(--accent); }

    /* Connection overlay */
    .connecting {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      z-index: 200;
      transition: opacity 0.3s;
    }
    .connecting.hidden { opacity: 0; pointer-events: none; }
    .spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #222;
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .connecting p { margin-top: 16px; color: var(--text2); font-size: 13px; }

    /* Touch feedback */
    .touch-ripple {
      position: absolute;
      width: 60px;
      height: 60px;
      background: rgba(0, 255, 136, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%) scale(0);
      pointer-events: none;
      animation: ripple 0.4s ease-out forwards;
    }
    @keyframes ripple {
      to { transform: translate(-50%, -50%) scale(1); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="connecting" id="connecting">
    <div class="spinner"></div>
    <p>Connecting to browser...</p>
  </div>

  <div class="app">
    <header class="header">
      <div class="logo">EXODUS<span>XE</span></div>
      <div class="status">
        <span id="statusText">Waiting</span>
        <div class="status-dot" id="statusDot"></div>
      </div>
    </header>

    <div class="tab-bar" id="tabBar"></div>

    <div class="active-tab" id="activeTab">
      <strong>Waiting for browser...</strong>
    </div>

    <div class="main">
      <div class="trackpad" id="trackpad">
        <div class="trackpad-hint">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l3 3 3-3M19 9l3 3-3 3"/>
            <circle cx="12" cy="12" r="2"/>
          </svg>
          <div class="title">Swipe to move cursor</div>
          <div class="sub">Tap to click Â· Hold for right-click</div>
        </div>

        <div class="scroll-btns">
          <button class="scroll-btn" data-scroll="up">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 15l-6-6-6 6"/></svg>
          </button>
          <button class="scroll-btn" data-scroll="down">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
          </button>
        </div>
      </div>

      <div class="context-controls" id="contextControls"></div>
    </div>

    <div class="bottom-bar">
      <button class="action-btn" id="btnBack">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
      </button>
      <button class="action-btn primary" id="btnKeyboard">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M6 12h.01M10 12h.01M14 12h.01M18 12h.01M8 16h8"/></svg>
      </button>
      <button class="action-btn" id="btnRefresh">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
      </button>
    </div>
  </div>

  <div class="keyboard-overlay" id="keyboardOverlay">
    <div class="keyboard-header">
      <input type="text" class="keyboard-input" id="keyboardInput" placeholder="Type here..." autocomplete="off" autocapitalize="off" autocorrect="off">
      <button class="keyboard-done" id="keyboardDone">Done</button>
    </div>
    <div class="keyboard-grid" id="keyboardGrid"></div>
  </div>

  <script>
    let ws = null;
    let connected = false;
    let activeTab = null;
    let siteType = 'universal';
    let tabs = [];

    const roomId = window.location.pathname.split('/').pop();
    const wsUrl = `${location.protocol === 'https:' ? 'wss' : 'ws'}://${location.host}/ws/${roomId}`;

    // Connect
    function connect() {
      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'join', roomId, role: 'controller' }));
        // Request tabs after a short delay to ensure browser is ready
        setTimeout(() => {
          ws.send(JSON.stringify({ type: 'getTabs' }));
        }, 500);
        // Request again after longer delay as backup
        setTimeout(() => {
          ws.send(JSON.stringify({ type: 'getTabs' }));
        }, 2000);
      };

      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        console.log('ExodusXE Phone: Received:', msg.type, msg);

        if (msg.type === 'joined' || msg.type === 'status') {
          connected = msg.displays > 0;
          updateStatus();
          // Request tabs when status changes
          if (connected) {
            setTimeout(() => ws.send(JSON.stringify({ type: 'getTabs' })), 300);
          }
        }

        if (msg.type === 'activeTab') {
          activeTab = msg.tab;
          siteType = msg.siteType || 'universal';
          updateActiveTab();
          updateContextControls();
        }

        if (msg.type === 'tabList') {
          console.log('ExodusXE Phone: Got tabList with', msg.tabs?.length, 'tabs');
          tabs = msg.tabs || [];
          renderTabs();
        }
      };

      ws.onclose = () => {
        connected = false;
        updateStatus();
        setTimeout(connect, 2000);
      };
    }

    function send(msg) {
      if (ws?.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(msg));
        vibrate();
      }
    }

    function vibrate() {
      if (navigator.vibrate) navigator.vibrate(15);
    }

    // Status
    function updateStatus() {
      document.getElementById('connecting').classList.toggle('hidden', connected);
      document.getElementById('statusDot').classList.toggle('connected', connected);
      document.getElementById('statusText').textContent = connected ? 'Connected' : 'Waiting';
    }

    function updateActiveTab() {
      const el = document.getElementById('activeTab');
      if (activeTab) {
        try {
          const host = new URL(activeTab.url).hostname.replace('www.', '');
          el.innerHTML = `<strong>${siteType}</strong> Â· ${host}`;
        } catch (e) {
          el.innerHTML = `<strong>${activeTab.title?.slice(0, 30) || 'Tab'}</strong>`;
        }
      }
    }

    // Tabs
    function renderTabs() {
      const bar = document.getElementById('tabBar');
      bar.innerHTML = tabs.slice(0, 8).map(t => `
        <div class="tab-item ${t.active ? 'active' : ''}" data-id="${t.id}">
          <img src="${t.favIconUrl || ''}" onerror="this.style.display='none'">
          <span>${t.title?.slice(0, 15) || 'Tab'}</span>
        </div>
      `).join('');

      bar.querySelectorAll('.tab-item').forEach(el => {
        el.onclick = () => send({ type: 'switchTab', tabId: parseInt(el.dataset.id) });
      });
    }

    // Context controls
    const contexts = {
      youtube: [
        { icon: 'â¯ï¸', action: 'play', label: 'Play' },
        { icon: 'âª', action: 'seekBack', label: '-10s' },
        { icon: 'â©', action: 'seekForward', label: '+10s' },
        { icon: 'ðŸ”‡', action: 'mute', label: 'Mute' },
        { icon: 'â›¶', action: 'fullscreen', label: 'Full' },
        { icon: 'â­ï¸', action: 'next', label: 'Next' }
      ],
      netflix: [
        { icon: 'â¯ï¸', action: 'play' }, { icon: 'âª', action: 'seekBack' },
        { icon: 'â©', action: 'seekForward' }, { icon: 'ðŸ”‡', action: 'mute' }, { icon: 'â›¶', action: 'fullscreen' }
      ],
      slides: [
        { icon: 'â—€ï¸', action: 'prev', label: 'Prev' }, { icon: 'â–¶ï¸', action: 'next', label: 'Next' },
        { icon: 'â–¶ï¸', action: 'play', label: 'Present' }, { icon: 'âœ–ï¸', action: 'exit', label: 'Exit' }
      ],
      zoom: [
        { icon: 'ðŸŽ¤', action: 'mute', label: 'Mute' }, { icon: 'ðŸ“¹', action: 'video', label: 'Video' },
        { icon: 'ðŸ’¬', action: 'chat', label: 'Chat' }, { icon: 'ðŸ“´', action: 'leave', label: 'Leave' }
      ],
      meet: [
        { icon: 'ðŸŽ¤', action: 'mute', label: 'Mute' }, { icon: 'ðŸ“¹', action: 'video', label: 'Video' },
        { icon: 'ðŸ’¬', action: 'chat', label: 'Chat' }, { icon: 'ðŸ“´', action: 'leave', label: 'Leave' }
      ],
      universal: [
        { icon: 'â†‘', action: 'up' }, { icon: 'â†“', action: 'down' },
        { icon: 'â†µ', action: 'enter' }, { icon: 'âŽ‹', action: 'escape' },
        { icon: 'â£', action: 'space' }, { icon: 'â‡¥', action: 'tab' }
      ]
    };

    function updateContextControls() {
      const btns = contexts[siteType] || contexts.universal;
      document.getElementById('contextControls').innerHTML = btns.map(b =>
        `<button class="ctx-btn" data-action="${b.action}">${b.icon}${b.label ? ' ' + b.label : ''}</button>`
      ).join('');

      document.querySelectorAll('.ctx-btn').forEach(el => {
        el.onclick = () => send({ type: 'action', action: el.dataset.action });
      });
    }

    // Trackpad
    const trackpad = document.getElementById('trackpad');
    let lastTouch = null, touchStart = 0, moved = false;

    trackpad.addEventListener('touchstart', (e) => {
      e.preventDefault();
      trackpad.classList.add('active');
      lastTouch = e.touches[0];
      touchStart = Date.now();
      moved = false;
    }, { passive: false });

    trackpad.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!lastTouch) return;
      const t = e.touches[0];
      const dx = t.clientX - lastTouch.clientX;
      const dy = t.clientY - lastTouch.clientY;
      if (Math.abs(dx) > 1 || Math.abs(dy) > 1) {
        moved = true;
        send({ type: 'mouse', x: dx, y: dy });
      }
      lastTouch = t;
    }, { passive: false });

    trackpad.addEventListener('touchend', (e) => {
      e.preventDefault();
      trackpad.classList.remove('active');
      const duration = Date.now() - touchStart;

      if (!moved) {
        // Create ripple
        const rect = trackpad.getBoundingClientRect();
        const x = e.changedTouches[0].clientX - rect.left;
        const y = e.changedTouches[0].clientY - rect.top;
        const ripple = document.createElement('div');
        ripple.className = 'touch-ripple';
        ripple.style.left = x + 'px';
        ripple.style.top = y + 'px';
        trackpad.appendChild(ripple);
        setTimeout(() => ripple.remove(), 400);

        if (duration < 200) {
          send({ type: 'mouse', x: 0, y: 0, action: 'click' });
        } else if (duration >= 400) {
          send({ type: 'mouse', x: 0, y: 0, action: 'rightClick' });
        }
      }
      lastTouch = null;
    }, { passive: false });

    // Two-finger scroll
    let lastTwoFinger = null;
    trackpad.addEventListener('touchmove', (e) => {
      if (e.touches.length === 2) {
        e.preventDefault();
        const avgY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
        if (lastTwoFinger !== null) {
          const dy = lastTwoFinger - avgY;
          send({ type: 'scroll', deltaY: dy * 3 });
        }
        lastTwoFinger = avgY;
      } else {
        lastTwoFinger = null;
      }
    }, { passive: false });

    trackpad.addEventListener('touchend', () => { lastTwoFinger = null; });

    // Scroll buttons
    document.querySelectorAll('[data-scroll]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const deltaY = btn.dataset.scroll === 'up' ? -300 : 300;
        console.log('Scroll button clicked:', btn.dataset.scroll, 'deltaY:', deltaY);
        send({ type: 'scroll', deltaY });
        vibrate();
      });
    });

    // Bottom buttons
    document.getElementById('btnBack').onclick = () => send({ type: 'action', action: 'back' });
    document.getElementById('btnRefresh').onclick = () => {
      // Refresh both the page and the tab list
      send({ type: 'action', action: 'refresh' });
      send({ type: 'getTabs' });
    };

    // Keyboard
    const keyboardOverlay = document.getElementById('keyboardOverlay');
    const keyboardInput = document.getElementById('keyboardInput');

    const keyboardRows = [
      ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0'],
      ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p'],
      ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', 'âŒ«'],
      ['z', 'x', 'c', 'v', 'b', 'n', 'm', ',', '.', 'â†µ'],
      ['space']
    ];

    document.getElementById('keyboardGrid').innerHTML = keyboardRows.map(row =>
      `<div class="keyboard-row">${row.map(k => {
        if (k === 'âŒ«') return `<button class="key wide" data-key="Backspace">âŒ«</button>`;
        if (k === 'â†µ') return `<button class="key wide" data-key="Enter">â†µ</button>`;
        if (k === 'space') return `<button class="key space" data-key="Space">space</button>`;
        return `<button class="key" data-char="${k}">${k}</button>`;
      }).join('')}</div>`
    ).join('');

    document.querySelectorAll('#keyboardGrid .key').forEach(key => {
      key.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Key clicked:', key.dataset.key || key.dataset.char);

        if (key.dataset.key) {
          console.log('Sending key:', key.dataset.key);
          send({ type: 'keyboard', key: key.dataset.key });
          if (key.dataset.key === 'Backspace') {
            keyboardInput.value = keyboardInput.value.slice(0, -1);
          } else if (key.dataset.key === 'Space') {
            keyboardInput.value += ' ';
          }
        } else if (key.dataset.char) {
          console.log('Sending char:', key.dataset.char);
          send({ type: 'keyboard', text: key.dataset.char });
          keyboardInput.value += key.dataset.char;
        }
        vibrate();
      });
    });

    keyboardInput.addEventListener('input', (e) => {
      if (e.data) send({ type: 'keyboard', text: e.data });
    });

    keyboardInput.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' || e.key === 'Enter') {
        send({ type: 'keyboard', key: e.key });
      }
    });

    document.getElementById('btnKeyboard').onclick = () => {
      keyboardOverlay.classList.add('active');
      setTimeout(() => keyboardInput.focus(), 100);
    };

    document.getElementById('keyboardDone').onclick = () => {
      keyboardOverlay.classList.remove('active');
      keyboardInput.blur();
      keyboardInput.value = '';
    };

    // Periodic tab refresh (backup in case push doesn't work)
    setInterval(() => {
      if (ws?.readyState === WebSocket.OPEN && connected) {
        ws.send(JSON.stringify({ type: 'getTabs' }));
      }
    }, 5000);

    // Init
    updateContextControls();
    connect();
  </script>
</body>
</html>
